Как создать API GraphQL на Python
Узнайте, как использовать FastAPI, Strawberry и PostgreSQL для создания полнофункционального сервера CRUD GraphQL API на языке Python.

https://thepythoncode.com/article/build-a-graphql-api-with-fastapi-strawberry-and-postgres-python


Проект TO DO:

Python 3.11+: Код написан на Python версии 3.11+ и совместим с ним

Тест использования GraphQL + PostgreSQL + python + FastAPI

Мы рассмотрим, как создать сервер GraphQL на Python с помощью FastAPI, Strawberry и Postgres, создав простой проект.

FastAPI - современный веб-фреймворк
Strawberry — это библиотека GraphQL для Python. Strawberry легко интегрируется с FastAPI, что позволяет нам создать надежный API GraphQL поверх фреймворка FastAPI.
Для хранения данных мы выбрали Postgres в качестве базы данных и получать к нему доступ через SQLAlchemy.

Создадим простой API Python GraphQL для простого приложения To Do. 
Этот API GraphQL может обрабатывать следующие операции CRUD (создание, чтение, обновление, удаление:
 - Получите все задачи в списке дел
 - Получить определенную задачу по ее ID
 - Добавление новой задачи
 - Обновление задачи
 - Удаление задачи

В конце будет функционирующий API GraphQL, который может обрабатывать операции CRUD для простого приложения To Do и сохранять данные в базе данных.


Установка зависимостей

Чтобы начать работу с нашим сервером GraphQL, нам нужно установить несколько зависимостей. 
Прежде чем продолжить, убедитесь, что ваша виртуальная среда активирована.

Для работы требуются следующие зависимости:

- fastAPI
- strawberry-graphql[fastapi]: Этот пакет предоставляет необходимые инструменты для интеграции Strawberry с FastAPI, что позволяет нам эффективно создавать сервер GraphQL.
- uvicorn[стандарт]: Uvicorn - это молниеносный сервер ASGI, который мы будем использовать для запуска нашего приложения FastAPI.
-SQLAlchemy — это мощный набор инструментов SQL и библиотека объектно-реляционного отображения (ORM), которая позволит нам взаимодействовать с базой данных.
- psycopg2: Нам также потребуется установить пакет psycopg2, который предоставляет адаптер PostgreSQL для Python.

Чтобы создать requirements.txt, выполните команду: pip freeze > requirements.txt

в requirements.txt Должно быть:

anyio==3.7.0
click==8.1.3
fastapi==0.97.0
graphql-core==3.2.3
h11==0.14.0
httptools==0.5.0
idna==3.4
psycopg2-binary==2.9.6
pydantic==1.10.9
python-dateutil==2.8.2
python-decouple==3.8
python-dotenv==1.0.0
python-multipart==0.0.6
PyYAML==6.0
six==1.16.0
sniffio==1.3.0
SQLAlchemy==2.0.16
starlette==0.27.0
strawberry-graphql==0.186.1
typing_extensions==4.6.3
uvicorn==0.22.0
uvloop==0.17.0
watchfiles==0.19.0
websockets==11.0.3

Для установки: pip install -r requirements.txt


Инициализация сервера

Теперь создайте новый файл в корне вашего проекта и назовите его main.py:
 вставьте следующий код:

from fastapi import FastAPI
app = FastAPI()

В нашем случае мы создаем GraphQL API, для которого нужен только один маршрут — /graphql


Создание API GraphQL

Для этого мы соберем его как пакет Python и позже передадим его в качестве обработчика маршрута в маршрут /graphql.

$ mkdir graphql_server - Чтобы объявить graphql_server пакетом Python, нам нужно добавить в него новый файл с именем __init__.py:


Определение схемы

Теперь создадим новый файл в пакете graphql_server и назовем его schemas.py (именно здесь мы определим схему задачи):
Здесь мы определим схему задачи так, чтобы она имела следующие атрибуты:
- id — идентификатор задачи (который будет целочисленным типом)
- content — фактическое содержимое объекта задачи «Сделать» (например, «Мыть посуду»)
- is_done — который имеет тип boolean и сообщает, помечена ли данная задача как завершенная или нет. По умолчанию он также должен быть установлен в False.


Определение резолверов

По сути, сопоставитель в GraphQL — это функция или метод, который обрабатывает запросы к API GraphQL и определяет, 
как получить данные, запрошенные запросом GraphQL. В каком-то смысле резолвер выступает в качестве моста между схемой GraphQL 
и базовыми источниками данных (например, базами данных, такими как Postgres).

Сначала создайте новый файл, все еще в пакете graphql_server, и назовите его resolvers.py:

мы хотим охватить следующие операции CRUD (создание, чтение, обновление, удаление) в наших резолверах:

- Создать: Добавить новую задачу
- Прочитайте:
- Получите все задачи в списке дел
- Получить одну задачу (по ее id)
- Обновление: обновление задачи из списка дел
- Удалить: удаление определенной задачи из списка дел


Определение схем запросов и изменений

Теперь, когда у нас есть схема задач и сопоставители шаблонов, мы можем приступить к определению наиболее важных схем в нашем API GraphQL, схем запросов и мутаций.

Эти два типа схем являются особыми, поскольку именно их Strawberry будет использовать для обработки запросов и мутаций. Как правило, эти специальные схемы всегда называются так — Query and Mutation.

В нашем проекте мы хотим, чтобы схема запроса имела следующие атрибуты данных в соответствии с нашими требованиями к CRUD-операциям:

- задачи: Список[схемы. Task] - Список задач
- Задача: (Схемы. Задача | None) - Один объект Задачи (или Нет, если идентификатор, переданный запросу, не соответствует ни одной Задаче)

То же самое относится и к схеме Mutation:
- add_task: схема. Задача — добавляет новую задачу в список дел и возвращает вновь добавленную задачу.
- update_task: (схема. Задача | None) - Обновляет определенный объект задачи и возвращает обновленную задачу или null, если задачи с заданным идентификатором не существует.
- delete_task — Удаляет задачу с заданным идентификатором и возвращает null независимо от того, была ли операция успешной или нет. Кроме того, вам не нужно комментировать это.


Создание экземпляра обработчика маршрутов GraphQL

На этом шаге мы создадим экземпляр обработчика маршрута GraphQL, который FastAPI будет использовать для маршрутизации трафика из маршрута /graphql. Мы также передадим схемы Query и Mutation этому обработчику маршрутов.


Добавление маршрута GraphQL в FastAPI

Последним шагом в настройке нашего API GraphQL является его включение в приложение FastAPI, которое мы создали ранее.

Итак, возвращаясь к файлу main.py, импортируйте graphql_app из пакета graphql_server, который мы только что создали. Затем создайте новый маршрут FastAPI /graphql и установите graphql_app в качестве обработчика маршрута.


Построение слоя данных

Итак, следующим шагом в создании нашего API GraphQL будет работа над уровнем данных. Слой данных предоставляет интерфейс для взаимодействия нашего сервера GraphQL с базой данных и выполнения CRUD-операций.


Создание нового экземпляра базы данных Postgres









